# Slack Canvas Collector - アプリ仕様書

## 📱 アプリの概要

### コンセプト
Slackで特定の絵文字リアクションが付いているメッセージを自動収集し、Canvasに整理してまとめるアプリ。議事録作成、プロジェクト振り返り、フィードバック収集など、重要な情報を効率的に整理できる。

### 主な機能
- 絵文字リアクションをトリガーにメッセージを収集
- 収集結果をCanvas形式で整理・保存
- スラッシュコマンドで簡単に実行
- チャンネルや期間を指定して柔軟に収集

### ターゲットユーザー
- ドキュメント作成担当者
- プロジェクトマネージャー
- ナレッジ管理者
- 会議のファシリテーター

### 競合との差別化ポイント
**主要競合: Reacji Channeler（Slack公式アプリ）**
- Reacji Channeler: 絵文字リアクションでメッセージを別チャンネルに転送
- 本アプリ: Canvas形式で整理・蓄積（より見やすく、検索しやすい）

### 想定利用シーン
1. **週次ミーティング後**: `:アクションアイテム:` 付きメッセージを議事録Canvasにまとめる
2. **プロジェクト終了時**: `:学び:` 付きメッセージを振り返りCanvasに集約
3. **フィードバック収集**: `:いいね:` `:改善点:` で分類してまとめる
4. **重要な決定事項**: `:重要:` 付きメッセージを意思決定ログとして保存

---

## ✅ 最終仕様まとめ

### 基本仕様

| 項目 | 内容 |
|------|------|
| 対応絵文字 | 単一絵文字のみ（カスタム絵文字含む） |
| 実行方法 | スラッシュコマンド（手動実行） |
| 出力内容 | 投稿日時 + メッセージリンク |
| 実行タイプ | オンデマンド（必要な時に手動実行） |

### 収集範囲

#### デフォルト設定
- **対象チャンネル**: 実行したチャンネルのみ
- **対象期間**: 全期間
- **最大収集件数**: 500件

#### オプション指定
| オプション | 詳細 | 制限 |
|-----------|------|------|
| チャンネル追加 | `#チャンネル名` で指定 | 最大10チャンネル（実行チャンネル含む） |
| 期間指定 | `過去○日` で指定 | 1つのみ指定可能 |

#### 制約・ルール
- 複数の期間指定は**不可**（エラー）
- Botが参加していないチャンネルは**自動スキップ**（エラー出さない）
- 上限（500件）超過時は警告メッセージを表示

### コマンド文法

#### 基本形
```bash
/canvas-collect :絵文字:
```

#### オプション付き
```bash
# チャンネル追加（最大10チャンネル）
/canvas-collect :チェック: #マーケティング #営業 #開発

# 期間指定
/canvas-collect :チェック: 過去7日
/canvas-collect :チェック: 過去30日

# 組み合わせ（有効）
/canvas-collect :チェック: #マーケティング 過去30日
/canvas-collect :チェック: #営業 #開発 過去7日
```

#### エラーパターン
```bash
# NG: 複数の期間指定
/canvas-collect :チェック: 過去7日 過去30日
```

### Canvas仕様

#### Canvas名
- **形式**: `[絵文字] 収集ログ`
- **例**: `:チェック: 収集ログ`、`:重要: 収集ログ`

#### 作成・更新ルール
| 条件 | 動作 |
|------|------|
| 該当Canvasが存在しない | 新規作成（メッセージが見つかった場合のみ） |
| 該当Canvasが1つ存在 | そのCanvasに追記 |
| 該当Canvasが複数存在 | 最新のCanvasに追記 |
| 該当メッセージなし | Canvas作成しない |

#### 追記ルール
- **追記位置**: 一番下に追加
- **ソート順**: 投稿日時の古い順
- **重複チェック**: MVPでは行わない（API制約のため）
- **セクション構造**: 常に一番下に新規セクション追加（既存構造の解析なし）

### 出力フォーマット

```markdown
## [絵文字] 収集結果
最終更新: 2026-02-05 15:30 (UTC)
収集件数: 12件

### #開発チーム
#### 2026-02-04
- 09:20 (UTC) [メッセージを見る](https://workspace.slack.com/archives/...)
- 14:30 (UTC) [メッセージを見る](https://workspace.slack.com/archives/...)

#### 2026-02-05
- 10:15 (UTC) [メッセージを見る](https://workspace.slack.com/archives/...)

### #デザイン  
#### 2026-02-05
- 11:00 (UTC) [メッセージを見る](https://workspace.slack.com/archives/...)

---
（追記実行時は、この下に新セクションが追加される）
```

### UX/フィードバック

#### 実行中の表示
- **タイミング**: コマンド実行直後
- **形式**: エフェメラルメッセージ（実行者のみ表示）
- **内容**: リスがどんぐりを集めるアニメーション 🐿️ + 「収集中...」

#### 完了通知
```
✅ 12件のメッセージを収集しました
📄 Canvasを確認: [リンク]

💡 ヒント: 重複を避けるには期間指定がおすすめ！
例: /canvas-collect :チェック: 過去7日
```

#### 該当なしの場合
```
ℹ️ 該当するメッセージが見つかりませんでした
```

#### 上限超過の場合
```
⚠️ 500件以上のメッセージが見つかりました
期間を絞って再実行してください
例: /canvas-collect :チェック: 過去7日
```

### エラーメッセージ

#### 絵文字関連
```
❌ 絵文字 :checkkk: が見つかりません
正しい絵文字コードを指定してください
```

#### チャンネル関連
```
❌ チャンネル #存在しないチャンネル が見つかりません
```

#### 認証・権限関連
```
❌ アプリの権限が不足しています
管理者に再インストールを依頼してください
```

```
❌ アプリの認証が無効です
管理者に再インストールを依頼してください
```

```
❌ 認証エラーが発生しました
管理者にお問い合わせください
```

#### Canvas関連
```
❌ Canvasの編集権限がありません
チャンネル管理者に権限を確認してください
```

```
❌ Canvasの作成に失敗しました
しばらく待ってから再度お試しください
```

#### レート制限
```
⏳ 処理が混み合っています
しばらく待ってから再度お試しください
```

#### 同時実行
```
⏳ 現在 :チェック: の収集が実行中です
しばらく待ってから再度お試しください
```

#### 文法エラー
```
❌ 期間指定は1つまでです
```

---

## 🔧 追加仕様

### 同時実行制御

| 項目 | 内容 |
|------|------|
| ロック範囲 | 絵文字単位（`:チェック:` と `:重要:` は同時実行OK） |
| ロック中の動作 | エラーメッセージ出して即終了 |
| ロック解除 | 収集処理完了時（成功・失敗問わず） |
| タイムアウト | 3分で自動解除 |

### Canvas検索・作成ルール

| 項目 | 内容 |
|------|------|
| Canvas種類 | **Standalone Canvas**（`canvases.create` API使用） |
| チャンネル紐づけ | 作成時に `channel_id` 指定 → チャンネルタブに自動追加 |
| 検索方法 | `files.list?types=canvas&channel=C1234` → タイトルで完全一致フィルタ |
| 検索範囲 | コマンド実行チャンネル内のみ |
| 複数ヒット時 | 更新日時が最新のCanvasに追記 |
| Canvas作成場所 | 常にコマンド実行チャンネル（複数チャンネル指定時も同様） |
| 権限設定 | チャンネル紐づけにより、チャンネルメンバーが自動的に編集可能 |

#### ⚠️ Channel Canvas vs Standalone Canvas
- **Channel Canvas**: 1チャンネルに1つしか作成できない制限あり
- **Standalone Canvas**: 複数作成可能、`channel_id` 指定でチャンネルタブに追加可能
- → 絵文字ごとに別Canvasを作る仕様のため、**Standalone Canvas** を採用

### 重複チェック方針

| 項目 | 内容 |
|------|------|
| MVP方針 | **重複チェックは行わない** |
| 理由 | Canvas全文取得APIが存在しないため |
| ユーザーへの案内 | 完了メッセージで期間指定を推奨 |
| 将来対応 | ユーザー増加後にDB管理方式を検討 |

### スレッド収集

| 項目 | 内容 |
|------|------|
| 収集対象 | メインメッセージ＋スレッド返信、両方収集 |
| 表示方法 | 区別なし、全部フラットに時系列で並べる |
| 最適化 | リアクション付きスレッド親のみ `conversations.replies` を呼ぶ |

#### 処理フロー
```
1. conversations.history でメッセージ取得
2. 各メッセージの reactions 配列をチェック
3. 対象絵文字があるメッセージをリストに追加
4. リストの中でスレッド親（reply_count > 0）のものだけ
   → conversations.replies でスレッド返信を取得
   → 返信の中で対象絵文字があるものをリストに追加
5. Canvas検索・作成・追記
```

### Botスキップ時の通知

| 項目 | 内容 |
|------|------|
| 通知タイミング | 完了時にまとめて通知 |

#### スキップありの完了メッセージ例
```
✅ 8件のメッセージを収集しました
📄 Canvasを確認: [リンク]

⚠️ 以下のチャンネルはBotが参加していないためスキップしました:
・#営業
・#人事

💡 ヒント: 重複を避けるには期間指定がおすすめ！
```

### タイムゾーン

| 項目 | 内容 |
|------|------|
| 表示タイムゾーン | UTC固定 |
| 表示形式 | `2026-02-05 06:30 (UTC)` のように明記 |

### 期間指定（「過去○日」）

| 項目 | 内容 |
|------|------|
| 起点 | コマンド実行時刻から逆算 |
| 例 | 2/5 14:30に「過去7日」実行 → 1/29 14:30 〜 2/5 14:30 のメッセージが対象 |

### リトライポリシー

| 項目 | 内容 |
|------|------|
| 対象エラー | `ratelimited` のみ |
| 最大リトライ回数 | 3回 |
| 待機時間 | 指数バックオフ（1秒 → 2秒 → 4秒） |
| リトライ失敗時 | エラーメッセージを表示して終了 |
| その他のエラー | リトライしない（即座にエラー表示） |

---

## 🛠️ 技術仕様

### Canvas API

| 用途 | API | 補足 |
|------|-----|------|
| Canvas作成 | `canvases.create` | `channel_id` 指定でチャンネルタブに追加 |
| Canvas検索 | `files.list?types=canvas&channel=C1234` | タイトルでクライアント側フィルタ |
| Canvas追記 | `canvases.edit` | `insert_after` オペレーション使用 |
| セクションID取得 | `canvases.sections.lookup` | 追記位置特定用 |
| 権限設定 | `canvases.access.set` | 必要に応じて使用 |

#### Canvas作成リクエスト例
```json
{
  "title": ":チェック: 収集ログ",
  "channel_id": "C1234567890",
  "document_content": {
    "type": "markdown",
    "markdown": "## :チェック: 収集結果\n最終更新: 2026-02-05 15:30 (UTC)\n..."
  }
}
```

#### Canvas追記リクエスト例
```json
{
  "canvas_id": "F1234ABCD",
  "changes": [
    {
      "operation": "insert_after",
      "section_id": "temp:C:XXX...",
      "document_content": {
        "type": "markdown",
        "markdown": "### #開発チーム\n#### 2026-02-05\n- 10:15 (UTC) [メッセージを見る](https://...)"
      }
    }
  ]
}
```

### Markdownサポート状況

Canvas APIでサポートされるMarkdown要素:
- 見出し（h1〜h3）
- 太字・斜体・取り消し線
- 箇条書き・番号付きリスト
- チェックリスト（`- [ ]` / `- [x]`）
- テーブル（**300セル制限**）
- リンク
- コードブロック・インラインコード
- 引用
- 絵文字（`:emoji_name:` 形式）
- ユーザーメンション・チャンネルメンション

⚠️ **Block Kitは非対応**

### メッセージ収集API

| 用途 | API | 補足 |
|------|-----|------|
| メッセージ取得 | `conversations.history` | `oldest`/`latest` で期間指定可能 |
| スレッド返信取得 | `conversations.replies` | メインメッセージの `thread_ts` を指定 |
| Bot参加チャンネル確認 | `users.conversations` | スキップ判定用 |

#### 絵文字リアクション検索方法
`conversations.history` でメッセージ取得 → `reactions` 配列をチェック → 対象絵文字でフィルタ

```javascript
// レスポンス例
{
  "messages": [
    {
      "ts": "1234567890.123456",
      "text": "重要なメッセージです",
      "reactions": [
        { "name": "チェック", "count": 2, "users": ["U123", "U456"] }
      ]
    }
  ]
}
```

### 必要なOAuthスコープ

| スコープ | 用途 |
|---------|------|
| `canvases:write` | Canvas作成・編集 |
| `canvases:read` | Canvas読み取り |
| `files:read` | Canvas一覧取得（`files.list`） |
| `channels:history` | パブリックチャンネルのメッセージ取得 |
| `groups:history` | プライベートチャンネルのメッセージ取得 |
| `channels:read` | チャンネル情報取得 |
| `groups:read` | プライベートチャンネル情報取得 |
| `commands` | スラッシュコマンド |

### レート制限（Marketplace承認済みアプリ）

| API | レート制限 | 備考 |
|-----|-----------|------|
| `conversations.history` | Tier 3（50+/分） | 最大1000件/リクエスト |
| `conversations.replies` | Tier 3（50+/分） | 最大1000件/リクエスト |
| `canvases.create` | Tier 2 | - |
| `canvases.edit` | Tier 3 | - |
| `files.list` | Tier 2 | - |

### エラーコード対応表

| エラーコード | 発生タイミング | 対応方針 |
|-------------|---------------|---------|
| `not_in_channel` | `conversations.history` | スキップして続行 |
| `channel_not_found` | `conversations.history` | エラー表示して終了 |
| `missing_scope` | 全般 | エラー表示して終了 |
| `token_revoked` | 全般 | エラー表示して終了 |
| `invalid_auth` | 全般 | エラー表示して終了 |
| `canvas_editing_failed` | `canvases.edit` | エラー表示して終了 |
| `canvas_creation_failed` | `canvases.create` | エラー表示して終了 |
| `ratelimited` | 全般 | 自動リトライ（最大3回） |

### パフォーマンス見積もり

| シナリオ | API呼び出し回数 | 推定時間 |
|---------|----------------|---------|
| 単一チャンネル・50件・スレッドなし | 約5回 | **数秒** |
| 単一チャンネル・500件・スレッド10% | 約53回 | **約1分** |
| 単一チャンネル・500件・スレッド100% | 約504回 | **約10分** |
| 10チャンネル・500件・スレッド10% | 約62回 | **約1〜2分** |
| 10チャンネル・500件・スレッド100% | 約512回 | **約10分** |

※ スレッド取得最適化（リアクション付きスレッド親のみ取得）適用後の見積もり

---

## 🚀 次のステップ

### フェーズ1: 技術調査（1-2週間） ✅ 完了

#### 調査項目
1. **Slack API仕様確認** ✅
   - ~~セクション情報の取得可否~~ → **調査完了: API非公開のため機能削除**
   - ~~チャンネル情報・メンバーシップ取得方法~~ → **調査完了: `users.conversations` 使用**
   - ~~絵文字リアクション付きメッセージの検索方法~~ → **調査完了: `conversations.history` + フィルタリング**

2. **Canvas API調査** ✅
   - ~~Canvas作成・編集のAPI仕様~~ → **調査完了: Standalone Canvas採用**
   - ~~Canvas内容の読み取り・パース方法~~ → **調査完了: 全文取得API非公開**
   - ~~重複チェックの実装可能性~~ → **調査完了: MVPでは行わない**

3. **APIレート制限調査** ✅
   - ~~メッセージ取得の制限~~ → **調査完了: Marketplace承認でTier 3**
   - ~~複数チャンネル処理時のパフォーマンス~~ → **調査完了: 見積もり表参照**
   - ~~500件収集時の処理時間見積もり~~ → **調査完了: 1〜10分（スレッド数による）**

4. **認証・権限設計** ✅
   - ~~必要なOAuthスコープの特定~~ → **調査完了: 上記スコープ一覧参照**
   - ~~Bot Token vs User Tokenの選択~~ → **調査完了: Bot Token使用**
   - ~~権限エラーハンドリング方針~~ → **調査完了: エラーコード対応表参照**

#### 成果物
- ✅ 技術調査報告書（本仕様書に統合）
- ✅ 実装可能性の判定 → **実装可能**
- ✅ 代替案の検討 → 重複チェックはMVPで見送り

### フェーズ2: プロトタイプ開発（2-3週間）

#### MVP（最小機能製品）スコープ
- ✅ 単一チャンネルからの収集
- ✅ 全期間対象（期間指定なし）
- ✅ 基本的なCanvas作成・追記
- ✅ 簡易エラーハンドリング

#### 実装項目
1. スラッシュコマンドの基本実装
2. 絵文字リアクション付きメッセージの検索
3. Canvas作成・フォーマット生成
4. 基本的なエラーハンドリング

#### テスト
- 開発環境でのテスト
- 基本動作の確認
- パフォーマンス測定

### フェーズ3: 機能拡張（3-4週間）

#### 拡張機能実装
1. **複数チャンネル対応**
   - チャンネル指定パーサー実装
   - 複数チャンネルの並列処理
   - スキップ処理の実装

2. **期間指定機能**
   - 日付パーサー実装
   - メッセージフィルタリング

3. **スレッド収集最適化**
   - リアクション付きスレッド親のみ取得
   - 将来的にオプション化も検討

4. **エラーハンドリング強化**
   - 全エラーケースの実装
   - わかりやすいエラーメッセージ
   - リトライロジック（`ratelimited` のみ）

5. **同時実行制御**
   - 絵文字単位のロック機構
   - 3分タイムアウト
   - ロック中エラーメッセージ

### フェーズ4: UI/UX磨き（1-2週間）

#### 改善項目
1. **リスアニメーション実装** 🐿️
   - アニメーション素材作成
   - エフェメラルメッセージへの埋め込み
   - 進捗表示（オプション）

2. **フィードバック最適化**
   - 完了通知のデザイン
   - Canvasリンクの表示方法
   - エラーメッセージの改善

3. **Canvasフォーマット調整**
   - 視認性の向上
   - セクション区切りの最適化
   - 日付フォーマットの調整

### フェーズ5: テスト・リリース（2-3週間）

#### テスト計画
1. **単体テスト**
   - 各機能の動作確認
   - エッジケースのテスト

2. **統合テスト**
   - 実際のSlackワークスペースでの動作確認
   - 複数ユーザーでの同時実行テスト

3. **ベータテスト**
   - 限定ユーザーへの公開
   - フィードバック収集
   - バグ修正

#### リリース準備
1. ドキュメント作成
   - ユーザーガイド
   - インストール手順
   - トラブルシューティング

2. Slack App Directory申請準備
   - アプリ説明文
   - スクリーンショット
   - プライバシーポリシー

3. 本番リリース
   - 段階的ロールアウト
   - モニタリング体制構築
   - サポート体制整備

### スケジュール概算

| フェーズ | 期間 | 累計 | 状況 |
|---------|------|------|------|
| 技術調査 | 1-2週間 | 2週間 | ✅ 完了 |
| プロトタイプ開発 | 2-3週間 | 5週間 | 🔜 次のステップ |
| 機能拡張 | 3-4週間 | 9週間 | - |
| UI/UX磨き | 1-2週間 | 11週間 | - |
| テスト・リリース | 2-3週間 | 14週間 | - |

**合計: 約3-4ヶ月**

### 成功指標（KPI）

#### 開発段階
- [x] 技術調査完了・実装可能性確認
- [ ] MVPの動作確認
- [ ] 全機能の実装完了
- [ ] ベータテスト参加者からの肯定的フィードバック

#### リリース後（3ヶ月）
- インストール数: 50ワークスペース
- アクティブユーザー: 100人
- 平均実行回数: 週3回/ユーザー
- エラー率: 5%以下

---

## 📝 備考

### 技術調査完了事項

| 項目 | 結果 |
|------|------|
| Slack APIでセクション情報の取得 | ❌ 不可（API非公開） |
| Canvas APIの内容読み取り | ❌ 全文取得API非公開 |
| 絵文字リアクション検索 | ✅ `conversations.history` + フィルタリング |
| APIレート制限 | ✅ Marketplace承認でTier 3 |
| 同時実行制御 | ✅ Redis等でロック機構実装予定 |

### 決定事項まとめ

| 項目 | 決定内容 |
|------|----------|
| Canvas種類 | Standalone Canvas |
| 重複チェック | MVPでは行わない |
| スレッド取得 | リアクション付きスレッド親のみ取得 |
| リトライ対象 | `ratelimited` のみ（最大3回） |
| Token種類 | Bot Token |
| 配布方法 | Slack Marketplace |

### 未決定事項（将来対応）

| 項目 | 備考 |
|------|------|
| 削除されたメッセージの扱い | リンク先が404になった場合、放置でOK？ |
| 絵文字の表記揺れ | エイリアス問題への対応は要調査 |
| スレッド収集のオプション化 | 運用後に必要性を判断 |
| 重複チェックのDB管理 | ユーザー増加後に検討 |

### 将来的な拡張案
- リアルタイム収集モード（絵文字付与時に自動追加）
- フィルタリング機能強化（投稿者指定、キーワード検索）
- 出力フォーマットのカスタマイズ
- 他ツールとの連携（Notion、Google Docsなど）
- 分析機能（収集データの可視化）

---

**作成日**: 2026-02-05  
**最終更新日**: 2026-02-06  
**バージョン**: 1.4  
**ステータス**: 技術調査完了・プロトタイプ開発準備中

### 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0 | 2026-02-05 | 初版作成 |
| 1.1 | 2026-02-05 | 追加仕様（同時実行制御、Canvas検索ルール、スレッド収集、Botスキップ通知、タイムゾーン、期間指定の起点）を追記 |
| 1.2 | 2026-02-05 | セクション指定機能を削除（Slack APIでセクション情報が取得不可のため） |
| 1.3 | 2026-02-05 | Canvas技術仕様を追加（Standalone Canvas採用、API詳細、必要スコープ、レート制限）。技術調査結果を反映。未解決の技術課題を追記。 |
| 1.4 | 2026-02-06 | **フェーズ1技術調査完了**。重複チェック方針（MVPでは行わない）、スレッド取得最適化、パフォーマンス見積もり、エラーコード対応表、リトライポリシーを追加。エラーメッセージ一覧を拡充。 |
